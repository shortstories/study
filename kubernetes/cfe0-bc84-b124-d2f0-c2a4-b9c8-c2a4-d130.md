# 쿠버네티스 마스터

## 분산 시스템 디자인 패턴

### Sidecar pattern

메인 어플리케이션 컨테이너 + 사이드카 컨테이너

보통 메인 어플리케이션은 사이드카 컨테이너의 유무에 영향받지 않도록 해야됨. 그에 따라 사이드카 컨테이너가 수행하는 부분에 수정사항이 발생해도 메인 어플리케이션 컨테이너는 수정하지 않고 배포할 수 있음. 그리고 사이드카 컨테이너가 수행하는 작업이 메인 어플리케이션에게 부하를 주지도 않음.

ex\) log aggregation side car container. 메인 어플리케이션은 로컬에다가 로그를 파일로 쌓고 사이드카 컨테이너는 그 파일을 읽어서 로그 서버로 보내는 역할만 수행. 메인 어플리케이션은 사이드카 컨테이너가 있던지 없던지 정상적으로 작업 수행

### Ambassador pattern

메인 어플리케이션 컨테이너 + 엠베서더 컨테이너

외부 서비스를 마치 로컬에 있는 것 처럼 구성하는 패턴. 외부의 서비스를 참조해서 각종 작업을 대행해주는 로컬 엠베서더 컨테이너를 하나 띄워놓고 메인 어플리케이션 컨테이너는 모두 이 로컬 컨테이너를 통해서 작업을 수행하는 방식. 이렇게 하면 위와 마찬가지로 서비스 구성이 바뀌거나 했을 때 메인 어플리케이션 변경 없이 엠베서더 컨테이너만 갈아끼우면 된다는 장점이 생김. 뿐만 아니라 로컬 엠베서더 컨테이너에 failover나 load balancing같은 추가기능을 넣을 수 있고 마찬가지로 메인 어플리케이션에 관계없이 변경이 가능.

ex\) Consul을 이런 식으로 구성할 수 있는데, 실제 Consul 서비스는 외부에 Server모드로 3대를 띄워서 쿼럼을 구성해놓고, 로컬에다가 Client모드로 1대 띄워서 외부 쿼럼을 참조하도록 세팅. 이렇게 하면 consul에다가 kv 요청같은걸 보낼 때 localhost:8500으로 쏘기만 하면 외부 쿼럼의 존재유무를 몰라도 원하는 대로 동작하게 할 수 있음.

### Adapter pattern

메인 어플리케이션 컨테이너 -&gt; 어뎁터 컨테이너

서로 버전이 다른 컨테이너가 있고, breaking change가 발생하여 서로 output이 다른 상황에서 동일한 output을 만들어주기 위해서 사용하는 패턴. 어댑터 컨테이너는 모든 업데이트가 끝나고 output이 동일해질 때 까지만 유지.

## 쿠버네티스 API 구성

### Kubernetes API

가장 기본되는 API. Pod, Service 등 쿠버네티스의 기본 요소들에 대한 CRUD는 물론 그 이상의 API도 포함.

일반적으로 `/api/{api version}/{api path}` 의 형태로 구성되어있음.

### Autoscaling API

Node의 resource에 따라 Pod group을 생성, 삭제 등 관리하는 autoscaler 제어용 API

`/apis/autoscaling/v1/{path}`

### Batch API

배치 API를 통해서 작업을 수행하게 되면 1회용 Pod이 생성되고 작업이 끝나면 종료된다.

## 쿠버네티스 컴포넌트 구성

### 마스터 컴포넌트

마스터는 일반적으로 하나의 노드에게 일임하는게 보통. 필요하다면 여러 노드에 분산시킬 수도 있음.

#### API 서버

API서버는 scale out이 쉽도록 stateless로 구성되어있음. 모든 데이터는 etcd에 저장.

#### Etcd

분산 데이터 저장소. 전체 클러스터 상태를 기록.

#### 컨트롤러 매니저

여러 매니저를 하나의 바이너리로 통합한 도구. 복제 컨트롤러, 포드 컨트롤러, 서비스 컨트롤러, 엔드포인트 컨트롤러 등이 포함되어있으며 내부적으로는 쿠버네티스 API를 호출하는 식으로 동작.

#### 스케쥴러

Node를 사용해서 Pod를 Scheduling. Resource 상태, 서비스 상태, 하드웨어 및 소프트웨어 정책 제약 사항, 친화 및 비친화 명세 항목. 데이터 지역성, 마감시간 등 고려할 사항이 많음.

#### DNS

1.3부터 표준 클러스터에 포함되어있음. 일반적인 포드와 동일하게 스케쥴링됨. headless service를 제외하고 모든 서비스와 pod는 DNS domain을 가짐.

### 노드 컴포넌트

마스터 노드와 상호작용하면서 작업 수행 및 상태 업데이트.

#### 프록시

각 노드마다 있으며 low level 네트워크 관리업무 수행. 서비스를 지역적으로 반영하고 TCP, UDP forwarding을 수행하며 설정 및 Environment, DNS를 통해서 클러스터 IP 탐색.

#### 큐브릿



